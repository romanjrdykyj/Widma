#include <dsplib.h>
#include <testsignal.h>
#include <math.h>


#define NUM_SAMPLES 2048
#define AC_SAMPLES 1000
#pragma DATA_SECTION (bufor, ".input")

short bufor[NUM_SAMPLES];						//bufor do testsignal
const unsigned long long hz_cff = 768000;		//jest to liczba 23,4374 zapisana w formacie Q15

int ac_bufor[NUM_SAMPLES];		//bufor wejsciowy do funkcji acorr
int ac_output[AC_SAMPLES];		//bufor wyjsciowy do funkcji acorr

//wspolczynniki okna Hamminga
const short cff[NUM_SAMPLES] = {
		2621,2621,2621,2621,2622,2622,2623,2624,2625,2626,2628,2629,2631,2633,2635,2637,2639,2641,2644,2646,2649,
		2652,2655,2658,2662,2665,2669,2672,2676,2680,2684,2689,2693,2698,2703,2708,2713,2718,2723,2728,2734,2740,
		2746,2752,2758,2764,2771,2777,2784,2791,2798,2805,2812,2820,2827,2835,2843,2851,2859,2867,2875,2884,2893,
		2902,2910,2920,2929,2938,2948,2957,2967,2977,2987,2997,3008,3018,3029,3040,3050,3061,3073,3084,3095,3107,
		3119,3131,3143,3155,3167,3179,3192,3205,3217,3230,3244,3257,3270,3284,3297,3311,3325,3339,3353,3367,3382,
		3397,3411,3426,3441,3456,3471,3487,3502,3518,3534,3550,3566,3582,3598,3615,3631,3648,3665,3682,3699,3716,
		3734,3751,3769,3787,3804,3822,3841,3859,3877,3896,3915,3933,3952,3971,3991,4010,4029,4049,4069,4089,4109,
		4129,4149,4169,4190,4210,4231,4252,4273,4294,4315,4337,4358,4380,4402,4424,4446,4468,4490,4512,4535,4557,
		4580,4603,4626,4649,4672,4696,4719,4743,4767,4790,4814,4838,4863,4887,4911,4936,4961,4986,5010,5036,5061,
		5086,5111,5137,5163,5188,5214,5240,5266,5293,5319,5345,5372,5399,5426,5452,5479,5507,5534,5561,5589,5616,
		5644,5672,5700,5728,5756,5785,5813,5842,5870,5899,5928,5957,5986,6015,6044,6074,6103,6133,6163,6192,6222,
		6252,6283,6313,6343,6374,6404,6435,6466,6497,6528,6559,6590,6621,6653,6684,6716,6748,6780,6812,6844,6876,
		6908,6941,6973,7006,7038,7071,7104,7137,7170,7203,7236,7270,7303,7337,7370,7404,7438,7472,7506,7540,7574,
		7609,7643,7678,7712,7747,7782,7817,7852,7887,7922,7957,7993,8028,8064,8099,8135,8171,8207,8243,8279,8315,
		8351,8387,8424,8460,8497,8534,8570,8607,8644,8681,8718,8756,8793,8830,8868,8905,8943,8981,9018,9056,9094,
		9132,9170,9209,9247,9285,9324,9362,9401,9439,9478,9517,9556,9595,9634,9673,9712,9751,9791,9830,9870,9909,
		9949,9989,10028,10068,10108,10148,10188,10229,10269,10309,10349,10390,10430,10471,10512,10552,10593,10634,
		10675,10716,10757,10798,10839,10880,10922,10963,11004,11046,11087,11129,11171,11212,11254,11296,11338,11380,
		11422,11464,11506,11548,11591,11633,11675,11718,11760,11803,11845,11888,11931,11974,12016,12059,12102,12145,
		12188,12231,12274,12318,12361,12404,12447,12491,12534,12578,12621,12665,12709,12752,12796,12840,12884,12927,
		12971,13015,13059,13103,13147,13191,13236,13280,13324,13368,13413,13457,13502,13546,13590,13635,13680,13724,
		13769,13813,13858,13903,13948,13993,14037,14082,14127,14172,14217,14262,14307,14352,14397,14443,14488,14533,
		14578,14624,14669,14714,14759,14805,14850,14896,14941,14987,15032,15078,15123,15169,15214,15260,15306,15351,
		15397,15443,15489,15534,15580,15626,15672,15718,15764,15809,15855,15901,15947,15993,16039,16085,16131,16177,
		16223,16269,16315,16361,16407,16453,16500,16546,16592,16638,16684,16730,16776,16823,16869,16915,16961,17007,
		17054,17100,17146,17192,17238,17285,17331,17377,17423,17470,17516,17562,17608,17655,17701,17747,17793,17840,
		17886,17932,17978,18025,18071,18117,18163,18210,18256,18302,18348,18394,18441,18487,18533,18579,18625,18671,
		18718,18764,18810,18856,18902,18948,18994,19040,19086,19133,19179,19225,19271,19317,19363,19408,19454,19500,
		19546,19592,19638,19684,19730,19776,19821,19867,19913,19959,20004,20050,20096,20141,20187,20233,20278,20324,
		20369,20415,20460,20506,20551,20596,20642,20687,20732,20778,20823,20868,20913,20959,21004,21049,21094,21139,
		21184,21229,21274,21319,21364,21409,21453,21498,21543,21588,21632,21677,21721,21766,21810,21855,21899,21944,
		21988,22032,22077,22121,22165,22209,22253,22297,22341,22385,22429,22473,22517,22561,22605,22648,22692,22736,
		22779,22823,22866,22909,22953,22996,23039,23083,23126,23169,23212,23255,23298,23341,23384,23426,23469,23512,
		23555,23597,23640,23682,23725,23767,23809,23851,23894,23936,23978,24020,24062,24104,24145,24187,24229,24271,
		24312,24354,24395,24436,24478,24519,24560,24601,24642,24683,24724,24765,24806,24847,24887,24928,24969,25009,
		25049,25090,25130,25170,25210,25250,25290,25330,25370,25410,25449,25489,25529,25568,25607,25647,25686,25725,
		25764,25803,25842,25881,25920,25959,25997,26036,26074,26113,26151,26189,26227,26265,26303,26341,26379,26417,
		26455,26492,26530,26567,26604,26642,26679,26716,26753,26790,26827,26863,26900,26937,26973,27009,27046,27082,
		27118,27154,27190,27226,27262,27297,27333,27368,27404,27439,27474,27509,27544,27579,27614,27649,27684,27718,
		27753,27787,27821,27856,27890,27924,27958,27991,28025,28059,28092,28126,28159,28192,28225,28258,28291,28324,
		28357,28389,28422,28454,28487,28519,28551,28583,28615,28647,28678,28710,28741,28773,28804,28835,28866,28897,
		28928,28959,28990,29020,29051,29081,29111,29141,29171,29201,29231,29261,29290,29320,29349,29378,29407,29436,
		29465,29494,29523,29551,29580,29608,29636,29665,29693,29721,29748,29776,29804,29831,29858,29886,29913,29940,
		29967,29993,30020,30046,30073,30099,30125,30151,30177,30203,30229,30254,30280,30305,30331,30356,30381,30406,
		30430,30455,30479,30504,30528,30552,30576,30600,30624,30648,30671,30695,30718,30741,30764,30787,30810,30833,
		30855,30878,30900,30922,30944,30966,30988,31010,31031,31053,31074,31095,31116,31137,31158,31179,31199,31220,
		31240,31260,31280,31300,31320,31339,31359,31378,31398,31417,31436,31455,31473,31492,31510,31529,31547,31565,
		31583,31601,31619,31636,31654,31671,31688,31705,31722,31739,31756,31772,31789,31805,31821,31837,31853,31868,
		31884,31900,31915,31930,31945,31960,31975,31989,32004,32018,32033,32047,32061,32075,32088,32102,32115,32129,
		32142,32155,32168,32180,32193,32205,32218,32230,32242,32254,32266,32277,32289,32300,32312,32323,32334,32344,
		32355,32366,32376,32386,32397,32407,32416,32426,32436,32445,32454,32464,32473,32482,32490,32499,32507,32516,
		32524,32532,32540,32548,32555,32563,32570,32577,32584,32591,32598,32605,32611,32618,32624,32630,32636,32642,
		32647,32653,32658,32664,32669,32674,32678,32683,32688,32692,32696,32700,32704,32708,32712,32715,32719,32722,
		32725,32728,32731,32734,32736,32739,32741,32743,32745,32747,32749,32750,32752,32753,32754,32755,32756,32757,
		32757,32758,32758,32758,32758,32758,32758,32757,32757,32756,32755,32754,32753,32752,32750,32749,32747,32745,
		32743,32741,32739,32736,32734,32731,32728,32725,32722,32719,32715,32712,32708,32704,32700,32696,32692,32688,
		32683,32678,32674,32669,32664,32658,32653,32647,32642,32636,32630,32624,32618,32611,32605,32598,32591,32584,
		32577,32570,32563,32555,32548,32540,32532,32524,32516,32507,32499,32490,32482,32473,32464,32454,32445,32436,
		32426,32416,32407,32397,32386,32376,32366,32355,32344,32334,32323,32312,32300,32289,32277,32266,32254,32242,
		32230,32218,32205,32193,32180,32168,32155,32142,32129,32115,32102,32088,32075,32061,32047,32033,32018,32004,
		31989,31975,31960,31945,31930,31915,31900,31884,31868,31853,31837,31821,31805,31789,31772,31756,31739,31722,
		31705,31688,31671,31654,31636,31619,31601,31583,31565,31547,31529,31510,31492,31473,31455,31436,31417,31398,
		31378,31359,31339,31320,31300,31280,31260,31240,31220,31199,31179,31158,31137,31116,31095,31074,31053,31031,
		31010,30988,30966,30944,30922,30900,30878,30855,30833,30810,30787,30764,30741,30718,30695,30671,30648,30624,
		30600,30576,30552,30528,30504,30479,30455,30430,30406,30381,30356,30331,30305,30280,30254,30229,30203,30177,
		30151,30125,30099,30073,30046,30020,29993,29967,29940,29913,29886,29858,29831,29804,29776,29748,29721,29693,
		29665,29636,29608,29580,29551,29523,29494,29465,29436,29407,29378,29349,29320,29290,29261,29231,29201,29171,
		29141,29111,29081,29051,29020,28990,28959,28928,28897,28866,28835,28804,28773,28741,28710,28678,28647,28615,
		28583,28551,28519,28487,28454,28422,28389,28357,28324,28291,28258,28225,28192,28159,28126,28092,28059,28025,
		27991,27958,27924,27890,27856,27821,27787,27753,27718,27684,27649,27614,27579,27544,27509,27474,27439,27404,
		27368,27333,27297,27262,27226,27190,27154,27118,27082,27046,27009,26973,26937,26900,26863,26827,26790,26753,
		26716,26679,26642,26604,26567,26530,26492,26455,26417,26379,26341,26303,26265,26227,26189,26151,26113,26074,
		26036,25997,25959,25920,25881,25842,25803,25764,25725,25686,25647,25607,25568,25529,25489,25449,25410,25370,
		25330,25290,25250,25210,25170,25130,25090,25049,25009,24969,24928,24887,24847,24806,24765,24724,24683,24642,
		24601,24560,24519,24478,24436,24395,24354,24312,24271,24229,24187,24145,24104,24062,24020,23978,23936,23894,
		23851,23809,23767,23725,23682,23640,23597,23555,23512,23469,23426,23384,23341,23298,23255,23212,23169,23126,
		23083,23039,22996,22953,22909,22866,22823,22779,22736,22692,22648,22605,22561,22517,22473,22429,22385,22341,
		22297,22253,22209,22165,22121,22077,22032,21988,21944,21899,21855,21810,21766,21721,21677,21632,21588,21543,
		21498,21453,21409,21364,21319,21274,21229,21184,21139,21094,21049,21004,20959,20913,20868,20823,20778,20732,
		20687,20642,20596,20551,20506,20460,20415,20369,20324,20278,20233,20187,20141,20096,20050,20004,19959,19913,
		19867,19821,19776,19730,19684,19638,19592,19546,19500,19454,19408,19363,19317,19271,19225,19179,19133,19086,
		19040,18994,18948,18902,18856,18810,18764,18718,18671,18625,18579,18533,18487,18441,18394,18348,18302,18256,
		18210,18163,18117,18071,18025,17978,17932,17886,17840,17793,17747,17701,17655,17608,17562,17516,17470,17423,
		17377,17331,17285,17238,17192,17146,17100,17054,17007,16961,16915,16869,16823,16776,16730,16684,16638,16592,
		16546,16500,16453,16407,16361,16315,16269,16223,16177,16131,16085,16039,15993,15947,15901,15855,15809,15764,
		15718,15672,15626,15580,15534,15489,15443,15397,15351,15306,15260,15214,15169,15123,15078,15032,14987,14941,
		14896,14850,14805,14759,14714,14669,14624,14578,14533,14488,14443,14397,14352,14307,14262,14217,14172,14127,
		14082,14037,13993,13948,13903,13858,13813,13769,13724,13680,13635,13590,13546,13502,13457,13413,13368,13324,
		13280,13236,13191,13147,13103,13059,13015,12971,12927,12884,12840,12796,12752,12709,12665,12621,12578,12534,
		12491,12447,12404,12361,12318,12274,12231,12188,12145,12102,12059,12016,11974,11931,11888,11845,11803,11760,
		11718,11675,11633,11591,11548,11506,11464,11422,11380,11338,11296,11254,11212,11171,11129,11087,11046,11004,
		10963,10922,10880,10839,10798,10757,10716,10675,10634,10593,10552,10512,10471,10430,10390,10349,10309,10269,
		10229,10188,10148,10108,10068,10028,9989,9949,9909,9870,9830,9791,9751,9712,9673,9634,9595,9556,9517,9478,9439,
		9401,9362,9324,9285,9247,9209,9170,9132,9094,9056,9018,8981,8943,8905,8868,8830,8793,8756,8718,8681,8644,8607,
		8570,8534,8497,8460,8424,8387,8351,8315,8279,8243,8207,8171,8135,8099,8064,8028,7993,7957,7922,7887,7852,7817,
		7782,7747,7712,7678,7643,7609,7574,7540,7506,7472,7438,7404,7370,7337,7303,7270,7236,7203,7170,7137,7104,7071,
		7038,7006,6973,6941,6908,6876,6844,6812,6780,6748,6716,6684,6653,6621,6590,6559,6528,6497,6466,6435,6404,6374,
		6343,6313,6283,6252,6222,6192,6163,6133,6103,6074,6044,6015,5986,5957,5928,5899,5870,5842,5813,5785,5756,5728,
		5700,5672,5644,5616,5589,5561,5534,5507,5479,5452,5426,5399,5372,5345,5319,5293,5266,5240,5214,5188,5163,5137,
		5111,5086,5061,5036,5010,4986,4961,4936,4911,4887,4863,4838,4814,4790,4767,4743,4719,4696,4672,4649,4626,4603,
		4580,4557,4535,4512,4490,4468,4446,4424,4402,4380,4358,4337,4315,4294,4273,4252,4231,4210,4190,4169,4149,4129,
		4109,4089,4069,4049,4029,4010,3991,3971,3952,3933,3915,3896,3877,3859,3841,3822,3804,3787,3769,3751,3734,3716,
		3699,3682,3665,3648,3631,3615,3598,3582,3566,3550,3534,3518,3502,3487,3471,3456,3441,3426,3411,3397,3382,3367,
		3353,3339,3325,3311,3297,3284,3270,3257,3244,3230,3217,3205,3192,3179,3167,3155,3143,3131,3119,3107,3095,3084,
		3073,3061,3050,3040,3029,3018,3008,2997,2987,2977,2967,2957,2948,2938,2929,2920,2910,2902,2893,2884,2875,2867,
		2859,2851,2843,2835,2827,2820,2812,2805,2798,2791,2784,2777,2771,2764,2758,2752,2746,2740,2734,2728,2723,2718,
		2713,2708,2703,2698,2693,2689,2684,2680,2676,2672,2669,2665,2662,2658,2655,2652,2649,2646,2644,2641,2639,2637,
		2635,2633,2631,2629,2628,2626,2625,2624,2623,2622,2622,2621,2621,2621,2621 };


//funkcja obliczaj¹ca maksimum widma
int peak()
{
	int indeksprim;
	int l;
	int diff = 0;
	int max = 0;
	int maxprim = 0;
	for(l = 1; l<NUM_SAMPLES/4; l++)
	{
		diff = 0;
		diff = bufor[l] - bufor[l-1]; //liczenie pochodnej widma
		if(diff < 0)
		{
			maxprim = bufor[l-1];	//zapisanie przypuszczalnie maksymalnej wartosci pr¹zka widma
			if(maxprim > 300)		//ustawienie progu podlogi widmowej
			{
				if(maxprim >= max)	//porownanie kolejnego pr¹¿ka przy pochodnej ujemnej czy nie jest wikeszy...
				{
					max = maxprim;	//...i jesli jest to nadpisanie zmiennej
					indeksprim = l - 1;
				}
			}
		}
	}
	return indeksprim;
}


unsigned long long frequency(int indeks)
{
	return ((hz_cff*indeks) >> 15);	// obliczenie czestotliwosci uwzgledniajac procesor staloprzecinkowy
}



void main(void) {

	int i;
	int Re;
	int Im;
	int j = 0;



	memcpy(&bufor, &testsignal, sizeof(testsignal));		//kopiowanie tablic

	//zastosowanie okna
	//for(i=0;i<NUM_SAMPLES;i++)
	//{
	//	bufor[i] = _smpy(cff[i],bufor[i]);
	//}

	//obliczanie widma FFT z biblioteki DSPLIB
	rfft((DATA*)bufor,NUM_SAMPLES,SCALE);

	//obliczanie widma mocy
	for(i=0; i<NUM_SAMPLES; i=i+2)
	{
		Re = bufor[i];
		Re = _smpy(Re,Re);	//podniesienie do kwadratu liczby rzeczywistej w tablicy po zastosowaniu fft
		Im = bufor[i+1];
		Im = _smpy(Im,Im);  //podniesienie do kwadratu liczby urojonej w tablicy po zastosowaniu fft
		bufor[j] = Re + Im;	//dodajemy czesc urojona i rzeczywista
		j++;
	}
	//obliczanie widma amplutidowego
	sqrt_16((DATA*)bufor, (DATA*)bufor,NUM_SAMPLES);

	//obliczanie indeksu maksima widma
	int indeks = peak();
	//obliczanie czestotliwosci maksima widma
	unsigned long long hz = frequency(indeks);


	memcpy(&ac_bufor, &testsignal, sizeof(testsignal));	//kopiowanie tablicy

	//zapobieganie przepelnieniu zakresu; przesuniecie bitowe o 4
	for(i=0; i<NUM_SAMPLES; i++)
	{
		ac_bufor[i] >>= 4;
	}

	//wywolanie funkcji autokorelacji
	acorr((DATA*)ac_bufor,(DATA*)ac_output,NUM_SAMPLES,AC_SAMPLES,bias);


	//obliczanie maksimum funkcji acorr sposobem tak jak w funkcji peak()
	int diff = 0;
	int max = 0;
	int maxprim = 0;

	int indeks_acor = 0;
	for(i = 10; i<1000; i++)
	{
		diff=0;
		diff = ac_output[i] - ac_output[i-1];
		if(diff < 0)
		{
			maxprim = ac_output[i-1];
			if(maxprim >= max)
			{
				max = maxprim;
				indeks_acor = i-1;	//
			}
		}
	}

	while (1); // do not exit
}
